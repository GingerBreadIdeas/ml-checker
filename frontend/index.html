<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Mlechker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Bokeh resources - matching the Python backend version 3.4.3 -->
    <script src="https://cdn.bokeh.org/bokeh/release/bokeh-3.4.3.min.js" crossorigin="anonymous"></script>
    <script src="https://cdn.bokeh.org/bokeh/release/bokeh-widgets-3.4.3.min.js" crossorigin="anonymous"></script>
    <script src="https://cdn.bokeh.org/bokeh/release/bokeh-tables-3.4.3.min.js" crossorigin="anonymous"></script>
    
    <style>
      .sidebar-item {
        @apply flex items-center px-4 py-3 text-gray-700 hover:bg-blue-100 hover:text-blue-800 rounded-lg transition-colors duration-150;
      }
      .sidebar-item.active {
        @apply bg-blue-100 text-blue-800;
      }
      .sidebar-icon {
        @apply mr-3 text-lg;
      }
      .auth-input {
        @apply w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500;
      }
      .auth-btn {
        @apply w-full py-2 px-4 bg-blue-600 text-white rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2;
      }
      
      /* Bokeh visualization styling */
      #embedding-plot {
        width: 100%;
        overflow-x: auto;
      }
      
      /* Make Bokeh container stretch full width */
      .bk-root {
        width: 100% !important;
      }
      .bk-root .bk-grid-column {
        width: 100% !important;
      }
      .bk-root .bk-data-table {
        width: 100% !important;
      }
      /* Style Bokeh tables to fit the app theme */
      .bk-data-table {
        font-family: inherit !important;
      }
      .slick-header-column {
        background-color: #f3f4f6 !important;
        font-weight: 600 !important;
      }
      .bokeh-selected {
        background-color: #fecaca !important;
      }
      
      /* Dashboard chart styles */
      .donut {
        max-height: 200px;
      }
      .donut-ring {
        stroke: #EFEFEF;
      }
      .donut-segment {
        transform-origin: center;
        transition: all 0.3s ease-in-out;
      }
      .donut-segment:hover {
        stroke-width: 4;
      }
      .chart-text {
        font-family: Arial, sans-serif;
        fill: #333;
      }
      .chart-number {
        font-size: 0.5em;
        line-height: 1;
        font-weight: bold;
        text-anchor: middle;
      }
      .chart-label {
        font-size: 0.25em;
        text-anchor: middle;
        text-transform: uppercase;
      }
      
      /* Bar chart styles */
      .bar-chart {
        transition: all 0.3s ease;
      }
      .bar-chart:hover {
        filter: brightness(90%);
        transform: scaleY(1.05);
      }
    </style>
  </head>
  <body class="bg-gray-50 min-h-screen flex flex-col">
    <!-- Top Navigation Bar -->
    <header class="bg-white shadow-sm sticky top-0 z-10">
      <div class="max-w-full mx-auto px-4 sm:px-6 lg:px-8 flex justify-between items-center h-16">
        <div class="flex items-center">
          <!-- Sidebar toggle button -->
          <button id="sidebar-toggle" class="p-1 mr-3 text-gray-500 hover:text-gray-700 focus:outline-none">
            <i class="fas fa-bars text-xl"></i>
          </button>
          <h1 class="text-2xl font-bold text-gray-900">Mlechker</h1>
        </div>
        <div class="flex items-center space-x-4">
          <button id="settings-button" class="p-1 rounded-full text-gray-500 hover:text-gray-700 focus:outline-none">
            <i class="fas fa-cog text-xl"></i>
          </button>
          <div class="relative" id="user-menu">
            <button id="user-menu-button" class="p-1 rounded-full text-gray-500 hover:text-gray-700 focus:outline-none">
              <i class="fas fa-user-circle text-xl"></i>
            </button>
            <div id="user-dropdown" class="hidden absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg py-1 z-50">
              <div id="logged-in-menu" class="hidden">
                <div class="px-4 py-2 text-sm text-gray-700 border-b border-gray-200">
                  <div id="user-name">Username</div>
                  <div id="user-email" class="text-xs text-gray-500">user@example.com</div>
                </div>
                <a href="#settings" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Settings</a>
                <button id="logout-button" class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Logout</button>
              </div>
              <div id="logged-out-menu">
                <a href="#login" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Login</a>
                <a href="#register" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Register</a>
              </div>
            </div>
          </div>
        </div>
      </div>
    </header>

    <div class="flex flex-1 overflow-hidden">
      <!-- Sidebar Navigation -->
      <aside id="sidebar" class="w-64 bg-white shadow-md block transition-all duration-300 ease-in-out">
        <!-- Logo at the top of the sidebar -->
        <div class="px-2 py-4 flex justify-center">
          <img src="./assets/mlechker_logo.png" alt="MLechker Logo" class="w-56 max-w-full">
        </div>
        <nav class="px-2 py-3">
          <div class="py-2">
            <a href="#dashboard" class="sidebar-item active block w-full mb-1" data-page="dashboard">
              <i class="fas fa-home sidebar-icon"></i>
              <span>Dashboard</span>
            </a>
          </div>
          <div class="py-2 border-t border-gray-200">
            <a href="#tracking" class="sidebar-item block w-full mb-1" data-page="tracking">
              <i class="fas fa-chart-line sidebar-icon"></i>
              <span>Tracking</span>
            </a>
          </div>
          <div class="py-2 border-t border-gray-200">
            <a href="#anomaly" class="sidebar-item block w-full mb-1" data-page="anomaly">
              <i class="fas fa-exclamation-triangle sidebar-icon"></i>
              <span>Anomaly Detection</span>
            </a>
          </div>
          <div class="py-2 border-t border-gray-200">
            <a href="#settings" class="sidebar-item block w-full mb-1" data-page="settings">
              <i class="fas fa-cog sidebar-icon"></i>
              <span>Settings</span>
            </a>
          </div>
        </nav>
      </aside>

      <!-- Mobile Menu Button (visible only on mobile) -->
      <div class="md:hidden fixed bottom-4 right-4 z-20">
        <button id="mobile-menu-button" class="bg-blue-600 text-white p-3 rounded-full shadow-lg">
          <i class="fas fa-bars"></i>
        </button>
      </div>

      <!-- Main Content Area -->
      <main class="flex-1 overflow-y-auto p-4">
        <!-- Content Pages (only one visible at a time) -->
        <div id="dashboard-page" class="page active">
          <!-- Placeholder div for React dashboard component -->
          <div id="dashboard-react-root"></div>
          <p id="serverStatus" class="text-gray-500 mt-6 text-sm">Server Status: Online</p>
        </div>

        <div id="tracking-page" class="page hidden">
          <!-- Placeholder div for React tracking component -->
          <div id="tracking-react-root"></div>
          <p id="trackingStatus" class="text-gray-500 mt-6 text-sm"></p>
        </div>

        <div id="anomaly-page" class="page hidden">
          <!-- Placeholder div for React anomaly component -->
          <div id="anomaly-react-root"></div>
        </div>

        <div id="settings-page" class="page hidden">
          <!-- Placeholder div for React settings component -->
          <div id="settings-react-root"></div>
        </div>

        <!-- Login Page -->
        <div id="login-page" class="page hidden">
          <div class="max-w-md mx-auto">
            <h2 class="text-2xl font-semibold mb-4 text-center">Login</h2>
            <div class="bg-white p-6 rounded-lg shadow-md">
              <form id="login-form" class="space-y-4">
                <div>
                  <label for="login-username" class="block text-sm font-medium text-gray-700 mb-1">Username or Email</label>
                  <input type="text" id="login-username" class="auth-input" required>
                </div>
                <div>
                  <label for="login-password" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                  <input type="password" id="login-password" class="auth-input" required>
                </div>
                <div>
                  <button type="submit" class="auth-btn">Login</button>
                </div>
                <div id="login-error" class="text-red-500 text-sm text-center hidden"></div>
              </form>
              <div class="mt-4 text-center text-sm">
                <p>Don't have an account? <a href="#register" class="text-blue-600 hover:text-blue-800">Register here</a></p>
              </div>
            </div>
          </div>
        </div>

        <!-- Register Page -->
        <div id="register-page" class="page hidden">
          <div class="max-w-md mx-auto">
            <h2 class="text-2xl font-semibold mb-4 text-center">Register</h2>
            <div class="bg-white p-6 rounded-lg shadow-md">
              <form id="register-form" class="space-y-4">
                <div>
                  <label for="register-username" class="block text-sm font-medium text-gray-700 mb-1">Username</label>
                  <input type="text" id="register-username" class="auth-input" required>
                </div>
                <div>
                  <label for="register-email" class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                  <input type="email" id="register-email" class="auth-input" required>
                </div>
                <div>
                  <label for="register-password" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                  <input type="password" id="register-password" class="auth-input" required minlength="6">
                  <p class="text-xs text-gray-500 mt-1">Password must be at least 6 characters long</p>
                </div>
                <div>
                  <button type="submit" class="auth-btn">Register</button>
                </div>
                <div id="register-error" class="text-red-500 text-sm text-center hidden"></div>
              </form>
              <div class="mt-4 text-center text-sm">
                <p>Already have an account? <a href="#login" class="text-blue-600 hover:text-blue-800">Login here</a></p>
              </div>
            </div>
          </div>
        </div>

      </main>
    </div>

    <!-- Initialize React Components -->
    <script type="module" src="/src/dashboard.tsx"></script>
    <script type="module" src="/src/tracking.tsx"></script>
    <script type="module" src="/src/anomaly.tsx"></script>
    <script type="module" src="/src/settings.tsx"></script>
    
    <!-- JavaScript for navigation and authentication -->
    <script>
      document.addEventListener('DOMContentLoaded', function() {
        // Page navigation
        const pages = document.querySelectorAll('.page');
        const sidebarItems = document.querySelectorAll('.sidebar-item');
        const sidebar = document.getElementById('sidebar');
        const sidebarToggle = document.getElementById('sidebar-toggle');
        const mainContent = document.querySelector('main');
        const userMenuButton = document.getElementById('user-menu-button');
        const userDropdown = document.getElementById('user-dropdown');
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const logoutButton = document.getElementById('logout-button');
        const loggedInMenu = document.getElementById('logged-in-menu');
        const loggedOutMenu = document.getElementById('logged-out-menu');
        // Hardcoded backend URL for Docker environment
        const apiBaseUrl = 'http://localhost:8000';
        const apiUrl = `${apiBaseUrl}/api/v1`;
        let sidebarCollapsed = false;
        
        
        // Function to show selected page and highlight correct sidebar item
        function navigateToPage(pageId) {
          console.log("Navigating to page:", pageId);
          // Hide all pages
          pages.forEach(page => page.classList.add('hidden'));
          
          // Show selected page
          document.getElementById(pageId + '-page').classList.remove('hidden');
          
          // Update active sidebar item
          sidebarItems.forEach(item => {
            if (item.getAttribute('data-page') === pageId) {
              item.classList.add('active');
            } else {
              item.classList.remove('active');
            }
          });
        }
        
        // Toggle sidebar collapse
        function toggleSidebar() {
          sidebarCollapsed = !sidebarCollapsed;
          
          if (sidebarCollapsed) {
            sidebar.classList.remove('w-64');
            sidebar.classList.add('w-16');
            // Hide logo when collapsed
            sidebar.querySelector('img[alt="MLechker Logo"]').classList.add('hidden');
            sidebar.querySelectorAll('.sidebar-item span').forEach(span => {
              span.classList.add('hidden');
            });
            mainContent.classList.add('ml-16');
          } else {
            sidebar.classList.add('w-64');
            sidebar.classList.remove('w-16');
            // Show logo when expanded
            sidebar.querySelector('img[alt="MLechker Logo"]').classList.remove('hidden');
            sidebar.querySelectorAll('.sidebar-item span').forEach(span => {
              span.classList.remove('hidden');
            });
            mainContent.classList.remove('ml-16');
          }
        }
        
        // Authentication Functions
        function checkAuthStatus() {
          const token = localStorage.getItem('token');
          if (token) {
            // Get user details
            fetch(`${apiUrl}/users/me`, {
              headers: {
                'Authorization': `Bearer ${token}`
              }
            })
            .then(response => {
              if (response.ok) {
                return response.json();
              } else {
                // Token invalid or expired
                localStorage.removeItem('token');
                localStorage.removeItem('user');
                updateAuthUI(false);
                return null;
              }
            })
            .then(data => {
              if (data) {
                localStorage.setItem('user', JSON.stringify(data));
                updateAuthUI(true);
              }
            })
            .catch(error => {
              console.error('Error fetching user details:', error);
              localStorage.removeItem('token');
              localStorage.removeItem('user');
              updateAuthUI(false);
            });
          } else {
            updateAuthUI(false);
          }
        }
        
        function updateAuthUI(isLoggedIn) {
          if (isLoggedIn) {
            const user = JSON.parse(localStorage.getItem('user'));
            document.getElementById('user-name').textContent = user.username;
            document.getElementById('user-email').textContent = user.email;
            loggedInMenu.classList.remove('hidden');
            loggedOutMenu.classList.add('hidden');
          } else {
            loggedInMenu.classList.add('hidden');
            loggedOutMenu.classList.remove('hidden');
          }
        }
        
        function login(username, password) {
          const formData = new FormData();
          formData.append('username', username);
          formData.append('password', password);
          
          fetch(`${apiUrl}/auth/login`, {
            method: 'POST',
            body: formData
          })
          .then(response => {
            if (response.ok) {
              return response.json();
            } else {
              throw new Error('Login failed');
            }
          })
          .then(data => {
            localStorage.setItem('token', data.access_token);
            checkAuthStatus();
            navigateToPage('dashboard');
            document.getElementById('login-error').classList.add('hidden');
          })
          .catch(error => {
            console.error('Login error:', error);
            document.getElementById('login-error').textContent = 'Invalid username or password';
            document.getElementById('login-error').classList.remove('hidden');
          });
        }
        
        function register(username, email, password) {
          fetch(`${apiUrl}/auth/register`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              username,
              email,
              password
            })
          })
          .then(response => {
            if (response.ok) {
              return response.json();
            } else {
              return response.json().then(data => {
                throw new Error(data.detail || 'Registration failed');
              });
            }
          })
          .then(data => {
            // Auto login after registration
            login(username, password);
          })
          .catch(error => {
            console.error('Registration error:', error);
            document.getElementById('register-error').textContent = error.message;
            document.getElementById('register-error').classList.remove('hidden');
          });
        }
        
        function logout() {
          localStorage.removeItem('token');
          localStorage.removeItem('user');
          updateAuthUI(false);
          userDropdown.classList.add('hidden');
          navigateToPage('dashboard');
        }
        
        // Message tracking functionality is now handled by the React component
        
        
        // Add click event listener to sidebar toggle
        sidebarToggle.addEventListener('click', toggleSidebar);
        
        // Add click event listeners to sidebar items
        sidebarItems.forEach(item => {
          item.addEventListener('click', function(e) {
            e.preventDefault();
            const pageId = this.getAttribute('data-page');
            navigateToPage(pageId);
            
            
            // Update URL hash
            window.location.hash = pageId;
            
            // On mobile, close the sidebar when an item is clicked
            if (window.innerWidth < 768) {
              sidebar.classList.add('hidden');
            }
          });
        });
        
        // Handle navigation based on URL hash
        function handleHashChange() {
          const hash = window.location.hash.substring(1);
          if (hash && document.querySelector(`#${hash}-page`)) {
            navigateToPage(hash);
            
          } else if (window.location.hash === '') {
            // Default to dashboard if no hash
            navigateToPage('dashboard');
          }
        }
        
        // User menu toggle
        userMenuButton.addEventListener('click', function() {
          userDropdown.classList.toggle('hidden');
        });
        
        // Close dropdown when clicking outside
        document.addEventListener('click', function(event) {
          if (!userMenuButton.contains(event.target) && !userDropdown.contains(event.target)) {
            userDropdown.classList.add('hidden');
          }
        });
        
        // Settings button
        document.getElementById('settings-button').addEventListener('click', function() {
          navigateToPage('settings');
          window.location.hash = 'settings';
        });
        
        // Login form submission
        loginForm.addEventListener('submit', function(e) {
          e.preventDefault();
          const username = document.getElementById('login-username').value;
          const password = document.getElementById('login-password').value;
          login(username, password);
        });
        
        // Register form submission
        registerForm.addEventListener('submit', function(e) {
          e.preventDefault();
          const username = document.getElementById('register-username').value;
          const email = document.getElementById('register-email').value;
          const password = document.getElementById('register-password').value;
          register(username, email, password);
        });
        
        // Logout button
        logoutButton.addEventListener('click', logout);
        
        // Listen for hash changes
        window.addEventListener('hashchange', handleHashChange);
        
        // Initial navigation
        handleHashChange();
        
        // Initial auth check
        checkAuthStatus();
        
        // Mobile menu functionality
        const mobileMenuButton = document.getElementById('mobile-menu-button');
        
        mobileMenuButton.addEventListener('click', function() {
          sidebar.classList.toggle('hidden');
          sidebar.classList.toggle('fixed');
          sidebar.classList.toggle('inset-0');
          sidebar.classList.toggle('z-10');
          sidebar.classList.toggle('md:block');
        });
        
        // Responsive handling
        function handleResponsiveLayout() {
          if (window.innerWidth < 768) {
            sidebar.classList.add('hidden');
            sidebarCollapsed = false;
            sidebar.classList.add('w-64');
            sidebar.classList.remove('w-16');
            sidebar.querySelectorAll('.sidebar-item span').forEach(span => {
              span.classList.remove('hidden');
            });
          } else {
            sidebar.classList.remove('hidden', 'fixed', 'inset-0', 'z-10');
          }
        }
        
        // Visualization button removed

        // Initial responsive setup
        handleResponsiveLayout();
        

        // Listen for window resize events
        window.addEventListener('resize', handleResponsiveLayout);
        
        // Dashboard data is now managed by the React component
        
        // Add hover effects to bar chart bars with tooltips
        const barCharts = document.querySelectorAll('.bar-chart');
        barCharts.forEach(bar => {
          bar.addEventListener('mouseover', function() {
            // Get actual value from data attribute
            const value = this.getAttribute('data-value');
            const isRed = this.classList.contains('bg-red-500');
            const type = isRed ? 'potential injections' : 'normal messages';
            
            // Create tooltip div if it doesn't exist
            let tooltip = document.getElementById('bar-tooltip');
            if (!tooltip) {
              tooltip = document.createElement('div');
              tooltip.id = 'bar-tooltip';
              tooltip.className = 'absolute bg-gray-800 text-white py-1 px-2 rounded text-xs z-50 pointer-events-none';
              document.body.appendChild(tooltip);
            }
            
            // Set tooltip content and position
            tooltip.textContent = `${value} ${type}`;
            tooltip.style.display = 'block';
            
            // Position tooltip near the bar
            const rect = this.getBoundingClientRect();
            tooltip.style.left = `${rect.left + rect.width / 2 - tooltip.offsetWidth / 2}px`;
            tooltip.style.top = `${rect.top - tooltip.offsetHeight - 5}px`;
          });
          
          bar.addEventListener('mouseout', function() {
            // Hide tooltip on mouseout
            const tooltip = document.getElementById('bar-tooltip');
            if (tooltip) {
              tooltip.style.display = 'none';
            }
          });
        });
        
        // Check server status
        fetch(`${apiBaseUrl}/api/health`)
          .then(response => {
            if (!response.ok) {
              throw new Error(`HTTP error! Status: ${response.status}`);
            }
            return response.json();
          })
          .then(data => {
            document.getElementById('serverStatus').textContent = 
              `Server Status: ${data.status || 'Online'}`;
          })
          .catch(error => {
            console.error('Error checking server status:', error);
            document.getElementById('serverStatus').textContent = 
              `Server Status: Error - ${error.message}`;
          });
      });
    </script>
    
    <!-- Initialize React Components -->
    <script type="module" src="/src/dashboard.tsx"></script>
    
    <script>
      // Initialize React components when the page loads and when navigating to their respective pages
      document.addEventListener('DOMContentLoaded', function() {
        // Initialize dashboard if it's active on page load
        if (typeof window.initDashboard === 'function' && 
            document.getElementById('dashboard-page').classList.contains('active')) {
          window.initDashboard('dashboard-react-root');
        }
        
        // Initialize tracking if it's active on page load
        if (typeof window.initTracking === 'function' && 
            document.getElementById('tracking-page').classList.contains('active')) {
          window.initTracking('tracking-react-root');
        }
        
        // Initialize anomaly if it's active on page load
        if (typeof window.initAnomaly === 'function' && 
            document.getElementById('anomaly-page').classList.contains('active')) {
          window.initAnomaly('anomaly-react-root');
        }
        
        // Initialize settings if it's active on page load
        if (typeof window.initSettings === 'function' && 
            document.getElementById('settings-page').classList.contains('active')) {
          window.initSettings('settings-react-root');
        }
        
        // Initialize when clicking any dashboard navigation link
        const dashboardNavLinks = document.querySelectorAll('[data-page="dashboard"]');
        dashboardNavLinks.forEach(link => {
          link.addEventListener('click', function() {
            // Small timeout to allow the page to become visible first
            setTimeout(() => {
              if (typeof window.initDashboard === 'function') {
                window.initDashboard('dashboard-react-root');
              }
            }, 50);
          });
        });
        
        // Initialize when clicking any tracking navigation link
        const trackingNavLinks = document.querySelectorAll('[data-page="tracking"]');
        trackingNavLinks.forEach(link => {
          link.addEventListener('click', function() {
            // Small timeout to allow the page to become visible first
            setTimeout(() => {
              if (typeof window.initTracking === 'function') {
                window.initTracking('tracking-react-root');
              }
            }, 50);
          });
        });
        
        // Initialize when clicking any anomaly navigation link
        const anomalyNavLinks = document.querySelectorAll('[data-page="anomaly"]');
        anomalyNavLinks.forEach(link => {
          link.addEventListener('click', function() {
            // Small timeout to allow the page to become visible first
            setTimeout(() => {
              if (typeof window.initAnomaly === 'function') {
                window.initAnomaly('anomaly-react-root');
              }
            }, 50);
          });
        });
        
        // Initialize when clicking any settings navigation link
        const settingsNavLinks = document.querySelectorAll('[data-page="settings"]');
        settingsNavLinks.forEach(link => {
          link.addEventListener('click', function() {
            // Small timeout to allow the page to become visible first
            setTimeout(() => {
              if (typeof window.initSettings === 'function') {
                window.initSettings('settings-react-root');
              }
            }, 50);
          });
        });
      });
    </script>
  </body>
</html>
