<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Mlechker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Bokeh resources - matching the Python backend version 3.4.3 -->
    <script src="https://cdn.bokeh.org/bokeh/release/bokeh-3.4.3.min.js" crossorigin="anonymous"></script>
    <script src="https://cdn.bokeh.org/bokeh/release/bokeh-widgets-3.4.3.min.js" crossorigin="anonymous"></script>
    <script src="https://cdn.bokeh.org/bokeh/release/bokeh-tables-3.4.3.min.js" crossorigin="anonymous"></script>
    
    <style>
      .sidebar-item {
        @apply flex items-center px-4 py-3 text-gray-700 hover:bg-blue-100 hover:text-blue-800 rounded-lg transition-colors duration-150;
      }
      .sidebar-item.active {
        @apply bg-blue-100 text-blue-800;
      }
      .sidebar-icon {
        @apply mr-3 text-lg;
      }
      .auth-input {
        @apply w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500;
      }
      .auth-btn {
        @apply w-full py-2 px-4 bg-blue-600 text-white rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2;
      }
      
      /* Bokeh visualization styling */
      #embedding-plot {
        width: 100%;
        overflow-x: auto;
      }
      
      /* Make Bokeh container stretch full width */
      .bk-root {
        width: 100% !important;
      }
      .bk-root .bk-grid-column {
        width: 100% !important;
      }
      .bk-root .bk-data-table {
        width: 100% !important;
      }
      /* Style Bokeh tables to fit the app theme */
      .bk-data-table {
        font-family: inherit !important;
      }
      .slick-header-column {
        background-color: #f3f4f6 !important;
        font-weight: 600 !important;
      }
      .bokeh-selected {
        background-color: #fecaca !important;
      }
      
      /* Dashboard chart styles */
      .donut {
        max-height: 200px;
      }
      .donut-ring {
        stroke: #EFEFEF;
      }
      .donut-segment {
        transform-origin: center;
        transition: all 0.3s ease-in-out;
      }
      .donut-segment:hover {
        stroke-width: 4;
      }
      .chart-text {
        font-family: Arial, sans-serif;
        fill: #333;
      }
      .chart-number {
        font-size: 0.5em;
        line-height: 1;
        font-weight: bold;
        text-anchor: middle;
      }
      .chart-label {
        font-size: 0.25em;
        text-anchor: middle;
        text-transform: uppercase;
      }
      
      /* Bar chart styles */
      .bar-chart {
        transition: all 0.3s ease;
      }
      .bar-chart:hover {
        filter: brightness(90%);
        transform: scaleY(1.05);
      }
    </style>
  </head>
  <body class="bg-gray-50 min-h-screen flex flex-col">
    <!-- Top Navigation Bar -->
    <header class="bg-white shadow-sm sticky top-0 z-10">
      <div class="max-w-full mx-auto px-4 sm:px-6 lg:px-8 flex justify-between items-center h-16">
        <div class="flex items-center">
          <!-- Sidebar toggle button -->
          <button id="sidebar-toggle" class="p-1 mr-3 text-gray-500 hover:text-gray-700 focus:outline-none">
            <i class="fas fa-bars text-xl"></i>
          </button>
          <h1 class="text-2xl font-bold text-gray-900">Mlechker</h1>
        </div>
        <div class="flex items-center space-x-4">
          <button id="settings-button" class="p-1 rounded-full text-gray-500 hover:text-gray-700 focus:outline-none">
            <i class="fas fa-cog text-xl"></i>
          </button>
          <div class="relative" id="user-menu">
            <button id="user-menu-button" class="p-1 rounded-full text-gray-500 hover:text-gray-700 focus:outline-none">
              <i class="fas fa-user-circle text-xl"></i>
            </button>
            <div id="user-dropdown" class="hidden absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg py-1 z-50">
              <div id="logged-in-menu" class="hidden">
                <div class="px-4 py-2 text-sm text-gray-700 border-b border-gray-200">
                  <div id="user-name">Username</div>
                  <div id="user-email" class="text-xs text-gray-500">user@example.com</div>
                </div>
                <a href="#settings" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Settings</a>
                <button id="logout-button" class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Logout</button>
              </div>
              <div id="logged-out-menu">
                <a href="#login" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Login</a>
                <a href="#register" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Register</a>
              </div>
            </div>
          </div>
        </div>
      </div>
    </header>

    <div class="flex flex-1 overflow-hidden">
      <!-- Sidebar Navigation -->
      <aside id="sidebar" class="w-64 bg-white shadow-md block transition-all duration-300 ease-in-out">
        <!-- Logo at the top of the sidebar -->
        <div class="px-2 py-4 flex justify-center">
          <img src="./assets/mlechker_logo.png" alt="MLechker Logo" class="w-56 max-w-full">
        </div>
        <nav class="px-2 py-3">
          <div class="py-2">
            <a href="#dashboard" class="sidebar-item active block w-full mb-1" data-page="dashboard">
              <i class="fas fa-home sidebar-icon"></i>
              <span>Dashboard</span>
            </a>
          </div>
          <div class="py-2 border-t border-gray-200">
            <a href="#tracking" class="sidebar-item block w-full mb-1" data-page="tracking">
              <i class="fas fa-chart-line sidebar-icon"></i>
              <span>Tracking</span>
            </a>
          </div>
          <div class="py-2 border-t border-gray-200">
            <a href="#anomaly" class="sidebar-item block w-full mb-1" data-page="anomaly">
              <i class="fas fa-exclamation-triangle sidebar-icon"></i>
              <span>Anomaly Detection</span>
            </a>
          </div>
          <div class="py-2 border-t border-gray-200">
            <a href="#settings" class="sidebar-item block w-full mb-1" data-page="settings">
              <i class="fas fa-cog sidebar-icon"></i>
              <span>Settings</span>
            </a>
          </div>
        </nav>
      </aside>

      <!-- Mobile Menu Button (visible only on mobile) -->
      <div class="md:hidden fixed bottom-4 right-4 z-20">
        <button id="mobile-menu-button" class="bg-blue-600 text-white p-3 rounded-full shadow-lg">
          <i class="fas fa-bars"></i>
        </button>
      </div>

      <!-- Main Content Area -->
      <main class="flex-1 overflow-y-auto p-4">
        <!-- Content Pages (only one visible at a time) -->
        <div id="dashboard-page" class="page active">
          <h2 class="text-2xl font-semibold mb-4">Dashboard</h2>
          
          <!-- Top row with stats and pie chart -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
            <!-- Total Messages Stat -->
            <div class="bg-white p-6 rounded-lg shadow-md">
              <h3 class="text-lg font-medium text-gray-700 mb-4">Total Messages</h3>
              <div class="flex items-center justify-center flex-col">
                <div class="text-8xl font-bold text-blue-600 leading-none mb-4" id="total-messages-count">1,247</div>
                <div class="flex items-center text-green-500 font-medium">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M12 7a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0V8.414l-4.293 4.293a1 1 0 01-1.414 0L8 10.414l-4.293 4.293a1 1 0 01-1.414-1.414l5-5a1 1 0 011.414 0L11 10.586 14.586 7H12z" clip-rule="evenodd" />
                  </svg>
                  <span>12.5% increase from last month</span>
                </div>
              </div>
            </div>
            
            <!-- Pie Chart -->
            <div class="bg-white p-6 rounded-lg shadow-md">
              <h3 class="text-lg font-medium text-gray-700 mb-2">Message Types</h3>
              <div class="w-full h-64 flex justify-center items-center" id="pie-chart-container">
                <!-- SVG Pie Chart (mock) - corrected segment positions -->
                <svg width="200" height="200" viewBox="0 0 42 42" class="donut">
                  <circle class="donut-hole" cx="21" cy="21" r="15.91549430918954" fill="#fff"></circle>
                  <circle class="donut-ring" cx="21" cy="21" r="15.91549430918954" fill="transparent" stroke="#d2d3d4" stroke-width="3"></circle>
                  <!-- Normal messages segment (95.3%) - starts at top (0 degrees) -->
                  <circle class="donut-segment" cx="21" cy="21" r="15.91549430918954" fill="transparent" stroke="#0074D9" stroke-width="3" stroke-dasharray="95.3 4.7" stroke-dashoffset="0"></circle>
                  <!-- Injection segment (4.7%) - continues where normal segment ends -->
                  <circle class="donut-segment" cx="21" cy="21" r="15.91549430918954" fill="transparent" stroke="#FF4136" stroke-width="3" stroke-dasharray="4.7 95.3" stroke-dashoffset="-95.3"></circle>
                  <g class="chart-text">
                    <text x="50%" y="50%" class="chart-number" text-anchor="middle" alignment-baseline="middle">
                      95.3%
                    </text>
                    <text x="50%" y="50%" class="chart-label" text-anchor="middle" alignment-baseline="middle" dy="1.2em">
                      normal
                    </text>
                  </g>
                </svg>
              </div>
              <div class="flex justify-center mt-4">
                <div class="flex items-center mr-6">
                  <div class="w-4 h-4 rounded-full bg-blue-500 mr-2"></div>
                  <span class="text-sm">Normal (95.3%)</span>
                </div>
                <div class="flex items-center">
                  <div class="w-4 h-4 rounded-full bg-red-500 mr-2"></div>
                  <span class="text-sm">Injections (4.7%)</span>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Bottom row with weekly chart -->
          <div class="bg-white p-6 rounded-lg shadow-md">
            <h3 class="text-lg font-medium text-gray-700 mb-4">Messages Last Week</h3>
            <!-- Simplified bar chart with explicit heights -->
            <div class="w-full p-4">
              <!-- Y-axis and chart grid -->
              <div class="flex" style="height: 400px">
                <!-- Y-axis labels -->
                <div class="flex flex-col justify-between pr-2 text-right">
                  <span class="text-xs text-gray-600">80</span>
                  <span class="text-xs text-gray-600">60</span>
                  <span class="text-xs text-gray-600">40</span>
                  <span class="text-xs text-gray-600">20</span>
                  <span class="text-xs text-gray-600">0</span>
                </div>
                
                <!-- Chart area with grid lines -->
                <div class="flex-1 relative">
                  <!-- Grid lines -->
                  <div class="absolute inset-0">
                    <div class="absolute top-0 w-full border-t border-gray-200"></div>
                    <div class="absolute top-1/4 w-full border-t border-gray-200"></div>
                    <div class="absolute top-2/4 w-full border-t border-gray-200"></div>
                    <div class="absolute top-3/4 w-full border-t border-gray-200"></div>
                    <div class="absolute bottom-0 w-full border-t border-gray-400"></div>
                  </div>
                  
                  <!-- Bars container -->
                  <div class="flex justify-between h-full items-end">
                    <!-- Monday -->
                    <div class="flex flex-col items-center mx-2" style="width: 40px;">
                      <div class="w-full bg-blue-500 rounded-t" style="height: 240px;" data-value="48"></div>
                      <div class="w-full bg-red-500 rounded-b mt-0.5" style="height: 20px;" data-value="4"></div>
                      <p class="text-xs mt-2 font-medium">Mon</p>
                    </div>
                    
                    <!-- Tuesday -->
                    <div class="flex flex-col items-center mx-2" style="width: 40px;">
                      <div class="w-full bg-blue-500 rounded-t" style="height: 180px;" data-value="36"></div>
                      <div class="w-full bg-red-500 rounded-b mt-0.5" style="height: 30px;" data-value="6"></div>
                      <p class="text-xs mt-2 font-medium">Tue</p>
                    </div>
                    
                    <!-- Wednesday -->
                    <div class="flex flex-col items-center mx-2" style="width: 40px;">
                      <div class="w-full bg-blue-500 rounded-t" style="height: 300px;" data-value="60"></div>
                      <div class="w-full bg-red-500 rounded-b mt-0.5" style="height: 40px;" data-value="8"></div>
                      <p class="text-xs mt-2 font-medium">Wed</p>
                    </div>
                    
                    <!-- Thursday -->
                    <div class="flex flex-col items-center mx-2" style="width: 40px;">
                      <div class="w-full bg-blue-500 rounded-t" style="height: 200px;" data-value="40"></div>
                      <div class="w-full bg-red-500 rounded-b mt-0.5" style="height: 10px;" data-value="2"></div>
                      <p class="text-xs mt-2 font-medium">Thu</p>
                    </div>
                    
                    <!-- Friday -->
                    <div class="flex flex-col items-center mx-2" style="width: 40px;">
                      <div class="w-full bg-blue-500 rounded-t" style="height: 260px;" data-value="52"></div>
                      <div class="w-full bg-red-500 rounded-b mt-0.5" style="height: 25px;" data-value="5"></div>
                      <p class="text-xs mt-2 font-medium">Fri</p>
                    </div>
                    
                    <!-- Saturday -->
                    <div class="flex flex-col items-center mx-2" style="width: 40px;">
                      <div class="w-full bg-blue-500 rounded-t" style="height: 120px;" data-value="24"></div>
                      <div class="w-full bg-red-500 rounded-b mt-0.5" style="height: 5px;" data-value="1"></div>
                      <p class="text-xs mt-2 font-medium">Sat</p>
                    </div>
                    
                    <!-- Sunday -->
                    <div class="flex flex-col items-center mx-2" style="width: 40px;">
                      <div class="w-full bg-blue-500 rounded-t" style="height: 100px;" data-value="20"></div>
                      <div class="w-full bg-red-500 rounded-b mt-0.5" style="height: 5px;" data-value="1"></div>
                      <p class="text-xs mt-2 font-medium">Sun</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
            <div class="flex justify-center mt-4">
              <div class="flex items-center mr-6">
                <div class="w-4 h-4 bg-blue-500 mr-2"></div>
                <span class="text-sm">Normal Messages</span>
              </div>
              <div class="flex items-center">
                <div class="w-4 h-4 bg-red-500 mr-2"></div>
                <span class="text-sm">Potential Injections</span>
              </div>
            </div>
            
            <p id="serverStatus" class="text-gray-500 mt-6 text-sm">Server Status: Online</p>
          </div>
        </div>

        <div id="tracking-page" class="page hidden">
          <h2 class="text-2xl font-semibold mb-4">Message Tracking</h2>
          
          <!-- Messages List -->
          <div class="bg-white p-6 rounded-lg shadow-md mb-4">
            <div class="flex justify-between items-center mb-6">
              <h3 class="text-lg font-medium">Your Chat Messages</h3>
              <div class="flex space-x-2">
                <select id="messages-per-page" class="border rounded px-2 py-1 text-sm">
                  <option value="5">5 per page</option>
                  <option value="10" selected>10 per page</option>
                  <option value="25">25 per page</option>
                  <option value="50">50 per page</option>
                </select>
                <button id="refresh-messages" class="bg-blue-100 text-blue-700 px-3 py-1 rounded hover:bg-blue-200">
                  <i class="fas fa-sync-alt"></i>
                </button>
              </div>
            </div>
            
            <!-- Loading indicator -->
            <div id="messages-loading" class="py-20 flex justify-center">
              <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
            </div>
            
            <!-- Empty state -->
            <div id="messages-empty" class="hidden py-20 text-center">
              <p class="text-gray-500">No messages found</p>
              <p class="text-gray-400 text-sm mt-2">Messages sent via the API will appear here</p>
            </div>
            
            <!-- Messages list -->
            <div id="messages-list" class="hidden space-y-4"></div>
            
            <!-- Message template (hidden, used for cloning) -->
            <template id="message-template">
              <div class="message-item border rounded-lg overflow-hidden">
                <div class="message-header bg-gray-50 px-4 py-3 flex justify-between items-center cursor-pointer hover:bg-gray-100">
                  <div class="flex items-center space-x-2">
                    <i class="message-icon fas fa-comment-alt text-blue-500"></i>
                    <p class="message-preview font-medium"></p>
                  </div>
                  <div class="flex items-center space-x-4">
                    <span class="message-date text-sm text-gray-500"></span>
                    <button class="message-delete text-red-500 hover:text-red-700">
                      <i class="fas fa-trash-alt"></i>
                    </button>
                    <i class="fas fa-chevron-down text-gray-400"></i>
                  </div>
                </div>
                <div class="message-details hidden p-4 border-t">
                  <div class="mb-4">
                    <h4 class="text-sm font-medium text-gray-500 mb-1">Message</h4>
                    <div class="message-content bg-gray-50 p-3 rounded"></div>
                  </div>
                  <div class="message-response-container">
                    <h4 class="text-sm font-medium text-gray-500 mb-1">Response</h4>
                    <div class="message-response bg-gray-50 p-3 rounded"></div>
                  </div>
                  <div class="mt-4 flex justify-between items-center">
                    <div class="flex items-center">
                      <label class="inline-flex items-center">
                        <input type="checkbox" class="prompt-injection-checkbox form-checkbox h-5 w-5 text-red-600">
                        <span class="ml-2 text-red-700 font-medium">Prompt Injection</span>
                      </label>
                    </div>
                    <div class="text-xs text-gray-500">
                      Message ID: <span class="message-id"></span>
                    </div>
                  </div>
                </div>
              </div>
            </template>
            
            <!-- Pagination -->
            <div id="messages-pagination" class="hidden mt-6 flex justify-between items-center">
              <button id="prev-page" class="bg-gray-100 text-gray-700 px-4 py-2 rounded disabled:opacity-50">
                <i class="fas fa-chevron-left mr-1"></i> Previous
              </button>
              <div class="text-sm text-gray-500">
                Page <span id="current-page">1</span> of <span id="total-pages">1</span>
              </div>
              <button id="next-page" class="bg-gray-100 text-gray-700 px-4 py-2 rounded disabled:opacity-50">
                Next <i class="fas fa-chevron-right ml-1"></i>
              </button>
            </div>
          </div>
          
          <!-- Visualization and API Hint Section -->
          <div class="space-y-4">
            
            <!-- API Hint -->
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 text-blue-800">
              <div class="flex">
                <div class="flex-shrink-0 mr-3">
                  <i class="fas fa-info-circle text-blue-500 text-xl"></i>
                </div>
                <div>
                  <h4 class="font-medium mb-1">Using the Messages API</h4>
                  <p class="text-sm">Messages are created via the API using your API token. Visit the Settings page to generate a token and see examples.</p>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div id="anomaly-page" class="page hidden">
          <h2 class="text-2xl font-semibold mb-4">Anomaly Detection</h2>
          
          <!-- Visualization Container -->
          <div class="bg-white p-6 rounded-lg shadow-md mb-6 w-full">
            <div class="flex justify-between items-center mb-4 w-full">
              <h3 class="text-lg font-medium">Message Embeddings Visualization</h3>
              <button id="refresh-embeddings" class="bg-blue-100 text-blue-700 px-3 py-1 rounded hover:bg-blue-200">
                <i class="fas fa-sync-alt mr-1"></i> Refresh
              </button>
            </div>
            
            <p class="text-gray-700 mb-4">This visualization shows text embeddings in 2D space using t-SNE dimensionality reduction. Regular messages are shown in blue, and potential prompt injections in red.</p>
            
            <!-- Loading indicator -->
            <div id="embeddings-loading" class="py-20 flex justify-center">
              <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
            </div>
            
            <!-- Empty state -->
            <div id="embeddings-empty" class="hidden py-20 text-center">
              <p class="text-gray-500">No messages found</p>
              <p class="text-gray-400 text-sm mt-2">Create some messages via the API first</p>
            </div>
            
            <!-- Error state -->
            <div id="embeddings-error" class="hidden py-20 text-center">
              <p class="text-red-500">Error loading visualization</p>
              <p id="embeddings-error-message" class="text-gray-500 text-sm mt-2"></p>
              <button id="embeddings-try-again" class="mt-4 bg-red-100 text-red-700 px-4 py-2 rounded hover:bg-red-200">
                Try Again
              </button>
            </div>
            
            <!-- Bokeh container -->
            <div id="bokeh-container" class="hidden w-full">
              <!-- Plot and table will be rendered here -->
              <div id="embedding-plot" class="mt-2 w-full"></div>
            </div>
          </div>
        </div>

        <div id="settings-page" class="page hidden">
          <h2 class="text-2xl font-semibold mb-4">Settings</h2>
          
          <!-- Preferences Section -->
          <div class="bg-white p-6 rounded-lg shadow-md mb-6">
            <h3 class="font-medium text-lg mb-4">Preferences</h3>
            <div class="space-y-2">
              <div class="flex items-center">
                <input type="checkbox" id="notifications" class="mr-2">
                <label for="notifications">Enable notifications</label>
              </div>
              <div class="flex items-center">
                <input type="checkbox" id="darkmode" class="mr-2">
                <label for="darkmode">Dark mode</label>
              </div>
            </div>
          </div>
          
          <!-- API Access Section -->
          <div class="bg-white p-6 rounded-lg shadow-md">
            <h3 class="font-medium text-lg mb-4">API Access</h3>
            <p class="text-gray-700 mb-4">Generate an API token to access the Echker API programmatically. This token will expire after 30 days.</p>
            
            <div id="api-token-section">
              <button id="generate-token-btn" class="auth-btn bg-blue-600 hover:bg-blue-700 mb-4">Generate New API Token</button>
              
              <div id="token-display" class="hidden">
                <div class="bg-gray-100 p-4 rounded-lg mb-4">
                  <h4 class="font-medium mb-2">Your API Token</h4>
                  <p class="text-xs text-gray-500 mb-2">Keep this token secure and don't share it with others.</p>
                  <div class="relative">
                    <input id="api-token-value" type="text" readonly class="auth-input pr-20 font-mono text-xs" value="">
                    <button id="copy-token-btn" class="absolute right-2 top-1/2 transform -translate-y-1/2 bg-blue-600 text-white px-2 py-1 rounded text-xs">Copy</button>
                  </div>
                </div>
                
                <div class="bg-gray-100 p-4 rounded-lg mb-4">
                  <h4 class="font-medium mb-2">Python Example</h4>
                  <pre class="bg-gray-800 text-gray-200 p-3 rounded-lg text-xs overflow-x-auto">
import requests

# API configuration
API_TOKEN = "your_token_here"
API_URL = "http://backend:8000/api/v1"

# Set up authorization header
headers = {
    "Authorization": f"Bearer {API_TOKEN}"
}

# Get your username
response = requests.get(
    f"{API_URL}/api/whoami", 
    headers=headers
)

if response.status_code == 200:
    data = response.json()
    print(f"Authenticated as: {data['username']}")
else:
    print(f"Error: {response.status_code} - {response.text}")
                  </pre>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Login Page -->
        <div id="login-page" class="page hidden">
          <div class="max-w-md mx-auto">
            <h2 class="text-2xl font-semibold mb-4 text-center">Login</h2>
            <div class="bg-white p-6 rounded-lg shadow-md">
              <form id="login-form" class="space-y-4">
                <div>
                  <label for="login-username" class="block text-sm font-medium text-gray-700 mb-1">Username or Email</label>
                  <input type="text" id="login-username" class="auth-input" required>
                </div>
                <div>
                  <label for="login-password" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                  <input type="password" id="login-password" class="auth-input" required>
                </div>
                <div>
                  <button type="submit" class="auth-btn">Login</button>
                </div>
                <div id="login-error" class="text-red-500 text-sm text-center hidden"></div>
              </form>
              <div class="mt-4 text-center text-sm">
                <p>Don't have an account? <a href="#register" class="text-blue-600 hover:text-blue-800">Register here</a></p>
              </div>
            </div>
          </div>
        </div>

        <!-- Register Page -->
        <div id="register-page" class="page hidden">
          <div class="max-w-md mx-auto">
            <h2 class="text-2xl font-semibold mb-4 text-center">Register</h2>
            <div class="bg-white p-6 rounded-lg shadow-md">
              <form id="register-form" class="space-y-4">
                <div>
                  <label for="register-username" class="block text-sm font-medium text-gray-700 mb-1">Username</label>
                  <input type="text" id="register-username" class="auth-input" required>
                </div>
                <div>
                  <label for="register-email" class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                  <input type="email" id="register-email" class="auth-input" required>
                </div>
                <div>
                  <label for="register-password" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                  <input type="password" id="register-password" class="auth-input" required minlength="6">
                  <p class="text-xs text-gray-500 mt-1">Password must be at least 6 characters long</p>
                </div>
                <div>
                  <button type="submit" class="auth-btn">Register</button>
                </div>
                <div id="register-error" class="text-red-500 text-sm text-center hidden"></div>
              </form>
              <div class="mt-4 text-center text-sm">
                <p>Already have an account? <a href="#login" class="text-blue-600 hover:text-blue-800">Login here</a></p>
              </div>
            </div>
          </div>
        </div>

      </main>
    </div>

    <!-- JavaScript for navigation and authentication -->
    <script>
      document.addEventListener('DOMContentLoaded', function() {
        // Page navigation
        const pages = document.querySelectorAll('.page');
        const sidebarItems = document.querySelectorAll('.sidebar-item');
        const sidebar = document.getElementById('sidebar');
        const sidebarToggle = document.getElementById('sidebar-toggle');
        const mainContent = document.querySelector('main');
        const userMenuButton = document.getElementById('user-menu-button');
        const userDropdown = document.getElementById('user-dropdown');
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const logoutButton = document.getElementById('logout-button');
        const loggedInMenu = document.getElementById('logged-in-menu');
        const loggedOutMenu = document.getElementById('logged-out-menu');
        // Hardcoded backend URL for Docker environment
        const apiBaseUrl = 'http://localhost:8000';
        const apiUrl = `${apiBaseUrl}/api/v1`;
        let sidebarCollapsed = false;
        
        // Get references to embedding visualization elements
        const embeddingsLoading = document.getElementById('embeddings-loading');
        const embeddingsEmpty = document.getElementById('embeddings-empty');
        const embeddingsError = document.getElementById('embeddings-error');
        const embeddingsErrorMessage = document.getElementById('embeddings-error-message');
        const embeddingsTryAgain = document.getElementById('embeddings-try-again');
        const bokehContainer = document.getElementById('bokeh-container');
        const refreshEmbeddingsBtn = document.getElementById('refresh-embeddings');
        
        // Cache for embedding visualization data
        let embeddingDataCache = null;
        let embeddingLastFetched = null;
        const CACHE_DURATION = 5 * 60 * 1000; // 5 minutes in milliseconds
        
        // Function to show selected page and highlight correct sidebar item
        function navigateToPage(pageId) {
          console.log("Navigating to page:", pageId);
          // Hide all pages
          pages.forEach(page => page.classList.add('hidden'));
          
          // Show selected page
          document.getElementById(pageId + '-page').classList.remove('hidden');
          
          // Update active sidebar item
          sidebarItems.forEach(item => {
            if (item.getAttribute('data-page') === pageId) {
              item.classList.add('active');
            } else {
              item.classList.remove('active');
            }
          });
        }
        
        // Toggle sidebar collapse
        function toggleSidebar() {
          sidebarCollapsed = !sidebarCollapsed;
          
          if (sidebarCollapsed) {
            sidebar.classList.remove('w-64');
            sidebar.classList.add('w-16');
            // Hide logo when collapsed
            sidebar.querySelector('img[alt="MLechker Logo"]').classList.add('hidden');
            sidebar.querySelectorAll('.sidebar-item span').forEach(span => {
              span.classList.add('hidden');
            });
            mainContent.classList.add('ml-16');
          } else {
            sidebar.classList.add('w-64');
            sidebar.classList.remove('w-16');
            // Show logo when expanded
            sidebar.querySelector('img[alt="MLechker Logo"]').classList.remove('hidden');
            sidebar.querySelectorAll('.sidebar-item span').forEach(span => {
              span.classList.remove('hidden');
            });
            mainContent.classList.remove('ml-16');
          }
        }
        
        // Authentication Functions
        function checkAuthStatus() {
          const token = localStorage.getItem('token');
          if (token) {
            // Get user details
            fetch(`${apiUrl}/users/me`, {
              headers: {
                'Authorization': `Bearer ${token}`
              }
            })
            .then(response => {
              if (response.ok) {
                return response.json();
              } else {
                // Token invalid or expired
                localStorage.removeItem('token');
                localStorage.removeItem('user');
                updateAuthUI(false);
                return null;
              }
            })
            .then(data => {
              if (data) {
                localStorage.setItem('user', JSON.stringify(data));
                updateAuthUI(true);
              }
            })
            .catch(error => {
              console.error('Error fetching user details:', error);
              localStorage.removeItem('token');
              localStorage.removeItem('user');
              updateAuthUI(false);
            });
          } else {
            updateAuthUI(false);
          }
        }
        
        function updateAuthUI(isLoggedIn) {
          if (isLoggedIn) {
            const user = JSON.parse(localStorage.getItem('user'));
            document.getElementById('user-name').textContent = user.username;
            document.getElementById('user-email').textContent = user.email;
            loggedInMenu.classList.remove('hidden');
            loggedOutMenu.classList.add('hidden');
          } else {
            loggedInMenu.classList.add('hidden');
            loggedOutMenu.classList.remove('hidden');
          }
        }
        
        function login(username, password) {
          const formData = new FormData();
          formData.append('username', username);
          formData.append('password', password);
          
          fetch(`${apiUrl}/auth/login`, {
            method: 'POST',
            body: formData
          })
          .then(response => {
            if (response.ok) {
              return response.json();
            } else {
              throw new Error('Login failed');
            }
          })
          .then(data => {
            localStorage.setItem('token', data.access_token);
            checkAuthStatus();
            navigateToPage('dashboard');
            document.getElementById('login-error').classList.add('hidden');
          })
          .catch(error => {
            console.error('Login error:', error);
            document.getElementById('login-error').textContent = 'Invalid username or password';
            document.getElementById('login-error').classList.remove('hidden');
          });
        }
        
        function register(username, email, password) {
          fetch(`${apiUrl}/auth/register`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              username,
              email,
              password
            })
          })
          .then(response => {
            if (response.ok) {
              return response.json();
            } else {
              return response.json().then(data => {
                throw new Error(data.detail || 'Registration failed');
              });
            }
          })
          .then(data => {
            // Auto login after registration
            login(username, password);
          })
          .catch(error => {
            console.error('Registration error:', error);
            document.getElementById('register-error').textContent = error.message;
            document.getElementById('register-error').classList.remove('hidden');
          });
        }
        
        function logout() {
          localStorage.removeItem('token');
          localStorage.removeItem('user');
          updateAuthUI(false);
          userDropdown.classList.add('hidden');
          navigateToPage('dashboard');
        }
        
        // Message tracking functionality
        const messagesPerPage = document.getElementById('messages-per-page');
        const refreshMessagesBtn = document.getElementById('refresh-messages');
        const messagesLoading = document.getElementById('messages-loading');
        const messagesEmpty = document.getElementById('messages-empty');
        const messagesList = document.getElementById('messages-list');
        const messageTemplate = document.getElementById('message-template');
        const messagesPagination = document.getElementById('messages-pagination');
        const prevPageBtn = document.getElementById('prev-page');
        const nextPageBtn = document.getElementById('next-page');
        const currentPageSpan = document.getElementById('current-page');
        const totalPagesSpan = document.getElementById('total-pages');
        
        // Messages state
        let currentPage = 1;
        let totalPages = 1;
        let pageSize = 10;
        
        // Format date helper
        function formatDate(dateString) {
          const date = new Date(dateString);
          return date.toLocaleString();
        }
        
        // Truncate text helper
        function truncateText(text, maxLength = 40) {
          if (text.length <= maxLength) return text;
          return text.substring(0, maxLength) + '...';
        }
        
        // Fetch messages function
        function fetchMessages() {
          console.log("fetchMessages function called");
          const token = localStorage.getItem('token');
          if (!token) {
            console.log("No token found, showing empty state");
            messagesLoading.classList.add('hidden');
            messagesEmpty.classList.remove('hidden');
            messagesList.classList.add('hidden');
            messagesPagination.classList.add('hidden');
            return;
          }
          
          // Show loading state
          messagesLoading.classList.remove('hidden');
          messagesEmpty.classList.add('hidden');
          messagesList.classList.add('hidden');
          messagesPagination.classList.add('hidden');
          
          // Calculate pagination parameters
          const skip = (currentPage - 1) * pageSize;
          
          const url = `${apiBaseUrl}/api/v1/chat/messages?skip=${skip}&limit=${pageSize}`;
          console.log("Fetching messages from:", url);
          
          fetch(url, {
            headers: {
              'Authorization': `Bearer ${token}`
            }
          })
          .then(response => {
            console.log("Fetch response status:", response.status);
            if (response.ok) {
              return response.json();
            } else {
              throw new Error(`Failed to fetch messages: ${response.status}`);
            }
          })
          .catch(error => {
            console.error("Fetch error:", error);
            throw error;
          })
          .then(data => {
            console.log("Received messages data:", data);
            // Hide loading state
            messagesLoading.classList.add('hidden');
            
            // Get messages from response
            const messages = data.messages || [];
            console.log("Messages array length:", messages.length);
            
            if (messages.length === 0) {
              console.log("No messages found, showing empty state");
              messagesEmpty.classList.remove('hidden');
              messagesList.classList.add('hidden');
              messagesPagination.classList.add('hidden');
              return;
            }
            
            // Clear existing messages
            messagesList.innerHTML = '';
            
            // Add each message to the list
            console.log("Processing messages to display");
            messages.forEach(message => {
              console.log("Processing message:", message.id, message.content);
              const messageElement = document.importNode(messageTemplate.content, true);
              
              // Set message data
              messageElement.querySelector('.message-preview').textContent = truncateText(message.content);
              messageElement.querySelector('.message-date').textContent = formatDate(message.created_at);
              messageElement.querySelector('.message-content').textContent = message.content;
              
              const responseContainer = messageElement.querySelector('.message-response-container');
              const responseElement = messageElement.querySelector('.message-response');
              
              if (message.response) {
                responseElement.textContent = message.response;
              } else {
                responseContainer.classList.add('hidden');
              }
              
              messageElement.querySelector('.message-id').textContent = message.id;
              
              // Set prompt injection checkbox
              const injectionCheckbox = messageElement.querySelector('.prompt-injection-checkbox');
              injectionCheckbox.checked = message.is_prompt_injection;
              
              // Style message header based on injection status
              const messageHeader = messageElement.querySelector('.message-header');
              const messageIcon = messageElement.querySelector('.message-icon');
              messageHeader.setAttribute('data-message-id', message.id);
              
              if (message.is_prompt_injection) {
                messageHeader.classList.add('bg-red-50');
                messageHeader.classList.remove('bg-gray-50');
                messageIcon.classList.remove('fa-comment-alt', 'text-blue-500');
                messageIcon.classList.add('fa-exclamation-triangle', 'text-red-500');
              }
              
              // Add toggle functionality
              const header = messageElement.querySelector('.message-header');
              const details = messageElement.querySelector('.message-details');
              const chevron = header.querySelector('.fa-chevron-down');
              
              header.addEventListener('click', function(e) {
                // Don't toggle if clicking the delete button
                if (e.target.closest('.message-delete')) return;
                
                details.classList.toggle('hidden');
                chevron.classList.toggle('fa-chevron-down');
                chevron.classList.toggle('fa-chevron-up');
              });
              
              // Add delete functionality
              const deleteBtn = messageElement.querySelector('.message-delete');
              deleteBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                if (confirm('Are you sure you want to delete this message?')) {
                  deleteMessage(message.id);
                }
              });
              
              // Add prompt injection toggle functionality
              // We already have the injectionCheckbox variable from above
              injectionCheckbox.addEventListener('change', function(e) {
                e.stopPropagation();
                updateMessageInjectionStatus(message.id, this.checked);
              });
              
              // Add to the list
              messagesList.appendChild(messageElement);
            });
            
            // Show the list
            messagesList.classList.remove('hidden');
            
            // Update pagination if we have data about total count
            // For now we'll just disable next button if we don't have a full page
            const hasMorePages = messages.length === pageSize;
            
            if (currentPage > 1 || hasMorePages) {
              messagesPagination.classList.remove('hidden');
              currentPageSpan.textContent = currentPage;
              totalPagesSpan.textContent = hasMorePages ? '?' : currentPage;
              
              prevPageBtn.disabled = currentPage === 1;
              nextPageBtn.disabled = !hasMorePages;
            }
          })
          .catch(error => {
            console.error('Error fetching messages:', error);
            messagesLoading.classList.add('hidden');
            messagesEmpty.classList.remove('hidden');
          });
        }
        
        // Delete message function
        function deleteMessage(messageId) {
          const token = localStorage.getItem('token');
          if (!token) return;
          
          fetch(`${apiBaseUrl}/api/v1/chat/messages/${messageId}`, {
            method: 'DELETE',
            headers: {
              'Authorization': `Bearer ${token}`
            }
          })
          .then(response => {
            if (response.ok) {
              // Refresh messages after deletion
              fetchMessages();
            } else {
              throw new Error('Failed to delete message');
            }
          })
          .catch(error => {
            console.error('Error deleting message:', error);
            alert('Error deleting message. Please try again.');
          });
        }
        
        // Update message's prompt injection status
        function updateMessageInjectionStatus(messageId, isPromptInjection) {
          const token = localStorage.getItem('token');
          if (!token) return;
          
          fetch(`${apiBaseUrl}/api/v1/chat/messages/${messageId}`, {
            method: 'PATCH',
            headers: {
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              is_prompt_injection: isPromptInjection
            })
          })
          .then(response => {
            if (response.ok) {
              // Update the UI to reflect the change without refreshing all messages
              const messageHeader = document.querySelector(`[data-message-id="${messageId}"]`);
              if (messageHeader) {
                const messageIcon = messageHeader.querySelector('.message-icon');
                
                if (isPromptInjection) {
                  messageHeader.classList.add('bg-red-50');
                  messageHeader.classList.remove('bg-gray-50');
                  messageIcon.classList.remove('fa-comment-alt', 'text-blue-500');
                  messageIcon.classList.add('fa-exclamation-triangle', 'text-red-500');
                } else {
                  messageHeader.classList.remove('bg-red-50');
                  messageHeader.classList.add('bg-gray-50');
                  messageIcon.classList.remove('fa-exclamation-triangle', 'text-red-500');
                  messageIcon.classList.add('fa-comment-alt', 'text-blue-500');
                }
              }
            } else {
              throw new Error('Failed to update message');
            }
          })
          .catch(error => {
            console.error('Error updating message:', error);
            alert('Error updating message. Please try again.');
            // Reset the checkbox to its previous state
            fetchMessages();
          });
        }
        
        // Set up message tracking event listeners
        if (refreshMessagesBtn) {
          refreshMessagesBtn.addEventListener('click', fetchMessages);
        }
        
        if (messagesPerPage) {
          messagesPerPage.addEventListener('change', function() {
            pageSize = parseInt(this.value);
            currentPage = 1;
            fetchMessages();
          });
        }
        
        if (prevPageBtn) {
          prevPageBtn.addEventListener('click', function() {
            if (currentPage > 1) {
              currentPage--;
              fetchMessages();
            }
          });
        }
        
        if (nextPageBtn) {
          nextPageBtn.addEventListener('click', function() {
            currentPage++;
            fetchMessages();
          });
        }
        
        // API Token generation functionality
        const generateTokenBtn = document.getElementById('generate-token-btn');
        const tokenDisplay = document.getElementById('token-display');
        const apiTokenValue = document.getElementById('api-token-value');
        const copyTokenBtn = document.getElementById('copy-token-btn');
        
        if (generateTokenBtn) {
          generateTokenBtn.addEventListener('click', function() {
            const token = localStorage.getItem('token');
            if (!token) {
              alert('You must be logged in to generate an API token');
              navigateToPage('login');
              return;
            }
            
            fetch(`${apiBaseUrl}/api/v1/auth/generate-api-token`, {
              method: 'POST',
              headers: {
                'Authorization': `Bearer ${token}`
              }
            })
            .then(response => {
              if (response.ok) {
                return response.json();
              } else {
                throw new Error('Failed to generate token');
              }
            })
            .then(data => {
              // Display the token
              apiTokenValue.value = data.access_token;
              tokenDisplay.classList.remove('hidden');
              
              // Update the example code with the token
              const exampleCode = document.querySelector('#token-display pre');
              if (exampleCode) {
                const updatedCode = exampleCode.textContent.replace(
                  'API_TOKEN = "your_token_here"',
                  `API_TOKEN = "${data.access_token}"`
                );
                exampleCode.textContent = updatedCode;
              }
            })
            .catch(error => {
              console.error('Error generating token:', error);
              alert('Error generating token. Please try again.');
            });
          });
        }
        
        if (copyTokenBtn) {
          copyTokenBtn.addEventListener('click', function() {
            apiTokenValue.select();
            document.execCommand('copy');
            alert('Token copied to clipboard');
          });
        }
        
        // Add click event listener to sidebar toggle
        sidebarToggle.addEventListener('click', toggleSidebar);
        
        // Add click event listeners to sidebar items
        sidebarItems.forEach(item => {
          item.addEventListener('click', function(e) {
            e.preventDefault();
            const pageId = this.getAttribute('data-page');
            navigateToPage(pageId);
            
            // Load data for different pages
            if (pageId === 'tracking') {
              console.log("Tracking page selected, calling fetchMessages()");
              fetchMessages();
            } else if (pageId === 'anomaly') {
              console.log("Anomaly page selected, loading embedding visualization");
              loadEmbeddingVisualization();
            }
            
            // Update URL hash
            window.location.hash = pageId;
            
            // On mobile, close the sidebar when an item is clicked
            if (window.innerWidth < 768) {
              sidebar.classList.add('hidden');
            }
          });
        });
        
        // Handle navigation based on URL hash
        function handleHashChange() {
          const hash = window.location.hash.substring(1);
          if (hash && document.querySelector(`#${hash}-page`)) {
            navigateToPage(hash);
            
            // Load messages when navigating to tracking page
            if (hash === 'tracking') {
              console.log("URL hash is 'tracking', calling fetchMessages()");
              fetchMessages();
            } else if (hash === 'anomaly') {
              console.log("URL hash is 'anomaly', loading embedding visualization");
              loadEmbeddingVisualization();
            }
          } else if (window.location.hash === '') {
            // Default to dashboard if no hash
            navigateToPage('dashboard');
          }
        }
        
        // User menu toggle
        userMenuButton.addEventListener('click', function() {
          userDropdown.classList.toggle('hidden');
        });
        
        // Close dropdown when clicking outside
        document.addEventListener('click', function(event) {
          if (!userMenuButton.contains(event.target) && !userDropdown.contains(event.target)) {
            userDropdown.classList.add('hidden');
          }
        });
        
        // Settings button
        document.getElementById('settings-button').addEventListener('click', function() {
          navigateToPage('settings');
          window.location.hash = 'settings';
        });
        
        // Login form submission
        loginForm.addEventListener('submit', function(e) {
          e.preventDefault();
          const username = document.getElementById('login-username').value;
          const password = document.getElementById('login-password').value;
          login(username, password);
        });
        
        // Register form submission
        registerForm.addEventListener('submit', function(e) {
          e.preventDefault();
          const username = document.getElementById('register-username').value;
          const email = document.getElementById('register-email').value;
          const password = document.getElementById('register-password').value;
          register(username, email, password);
        });
        
        // Logout button
        logoutButton.addEventListener('click', logout);
        
        // Listen for hash changes
        window.addEventListener('hashchange', handleHashChange);
        
        // Initial navigation
        handleHashChange();
        
        // Initial auth check
        checkAuthStatus();
        
        // Mobile menu functionality
        const mobileMenuButton = document.getElementById('mobile-menu-button');
        
        mobileMenuButton.addEventListener('click', function() {
          sidebar.classList.toggle('hidden');
          sidebar.classList.toggle('fixed');
          sidebar.classList.toggle('inset-0');
          sidebar.classList.toggle('z-10');
          sidebar.classList.toggle('md:block');
        });
        
        // Responsive handling
        function handleResponsiveLayout() {
          if (window.innerWidth < 768) {
            sidebar.classList.add('hidden');
            sidebarCollapsed = false;
            sidebar.classList.add('w-64');
            sidebar.classList.remove('w-16');
            sidebar.querySelectorAll('.sidebar-item span').forEach(span => {
              span.classList.remove('hidden');
            });
          } else {
            sidebar.classList.remove('hidden', 'fixed', 'inset-0', 'z-10');
          }
        }
        
        // Visualization button removed

        // Initial responsive setup
        handleResponsiveLayout();
        
        // Embedding visualization functionality - with caching
        function loadEmbeddingVisualization(forceRefresh = false) {
          const token = localStorage.getItem('token');
          if (!token) {
            embeddingsLoading.classList.add('hidden');
            embeddingsEmpty.classList.remove('hidden');
            embeddingsError.classList.add('hidden');
            bokehContainer.classList.add('hidden');
            return;
          }
          
          // Check if we have cached data and it's still valid
          const now = new Date().getTime();
          if (!forceRefresh && 
              embeddingDataCache && 
              embeddingLastFetched && 
              (now - embeddingLastFetched < CACHE_DURATION)) {
            console.log("Using cached embedding visualization data");
            
            // Use the cached data
            displayEmbeddingData(embeddingDataCache);
            return;
          }
          
          // Show loading state
          embeddingsLoading.classList.remove('hidden');
          embeddingsEmpty.classList.add('hidden');
          embeddingsError.classList.add('hidden');
          bokehContainer.classList.add('hidden');
          
          // Fetch embedding data as JSON
          fetch(`${apiBaseUrl}/api/v1/visualization/message_embeddings_json`, {
            headers: {
              'Authorization': `Bearer ${token}`
            }
          })
          .then(response => {
            if (response.ok) {
              return response.json();
            } else {
              throw new Error(`Failed to fetch embedding data: ${response.status}`);
            }
          })
          .then(data => {
            console.log("Received Bokeh JSON data:", data);
            
            // Update cache with new data
            embeddingDataCache = data;
            embeddingLastFetched = now;
            
            // Display the data
            displayEmbeddingData(data);
          })
          .catch(error => {
            console.error("Error loading embedding data:", error);
            embeddingsLoading.classList.add('hidden');
            embeddingsError.classList.remove('hidden');
            embeddingsErrorMessage.textContent = error.message;
          });
        }
        
        // Helper function to display embedding data
        function displayEmbeddingData(data) {
          // Hide loading state
          embeddingsLoading.classList.add('hidden');
          
          // Check for error response
          if (data.status === "error") {
            embeddingsError.classList.remove('hidden');
            embeddingsErrorMessage.textContent = data.message || "Error loading visualization";
            return;
          }
          
          // Check for empty response
          if (data.status === "empty") {
            embeddingsEmpty.classList.remove('hidden');
            return;
          }
          
          // Clear previous visualization
          document.getElementById('embedding-plot').innerHTML = '';
          
          try {
            // Properly embed Bokeh using json_item as per documentation
            Bokeh.embed.embed_item(data, "embedding-plot");
            
            // Show container
            bokehContainer.classList.remove('hidden');
          } catch (error) {
            console.error("Error rendering Bokeh visualization:", error);
            embeddingsError.classList.remove('hidden');
            embeddingsErrorMessage.textContent = `Error rendering visualization: ${error.message}`;
          }
        }
        
        // Set up event listeners for embedding visualization
        if (refreshEmbeddingsBtn) {
          refreshEmbeddingsBtn.addEventListener('click', () => loadEmbeddingVisualization(true));
        }
        
        if (embeddingsTryAgain) {
          embeddingsTryAgain.addEventListener('click', () => loadEmbeddingVisualization(true));
        }

        // Listen for window resize events
        window.addEventListener('resize', handleResponsiveLayout);
        
        // Initialize dashboard with mock data
        function initDashboard() {
          // Mock data
          const mockData = {
            totalMessages: 1247,
            normalMessages: 1189,
            injectionMessages: 58,
            weeklyData: [
              { day: 'Mon', normal: 48, injection: 4 },
              { day: 'Tue', normal: 36, injection: 6 },
              { day: 'Wed', normal: 60, injection: 8 },
              { day: 'Thu', normal: 40, injection: 2 },
              { day: 'Fri', normal: 52, injection: 5 },
              { day: 'Sat', normal: 24, injection: 1 },
              { day: 'Sun', normal: 20, injection: 1 }
            ]
          };
          
          // Calculate percentages
          const totalPercent = mockData.normalMessages / mockData.totalMessages * 100;
          const injectionPercent = mockData.injectionMessages / mockData.totalMessages * 100;
          
          // Update total messages count
          document.getElementById('total-messages-count').textContent = mockData.totalMessages.toLocaleString();
          
          // Update donut chart
          const donutSegments = document.querySelectorAll('.donut-segment');
          donutSegments[0].setAttribute('stroke-dasharray', `${totalPercent} ${100-totalPercent}`);
          donutSegments[1].setAttribute('stroke-dasharray', `${injectionPercent} ${100-injectionPercent}`);
          
          // Update chart text
          const chartNumber = document.querySelector('.chart-number');
          chartNumber.textContent = `${totalPercent.toFixed(1)}%`;
          
          // Update legend text
          const legendTexts = document.querySelectorAll('#pie-chart-container + div span');
          legendTexts[0].textContent = `Normal (${totalPercent.toFixed(1)}%)`;
          legendTexts[1].textContent = `Injections (${injectionPercent.toFixed(1)}%)`;
          
          // Bar chart could be updated similarly if needed
          // Already set static values in the HTML
        }
        
        // Initialize dashboard on page load
        initDashboard();
        
        // Add hover effects to bar chart bars with tooltips
        const barCharts = document.querySelectorAll('.bar-chart');
        barCharts.forEach(bar => {
          bar.addEventListener('mouseover', function() {
            // Get actual value from data attribute
            const value = this.getAttribute('data-value');
            const isRed = this.classList.contains('bg-red-500');
            const type = isRed ? 'potential injections' : 'normal messages';
            
            // Create tooltip div if it doesn't exist
            let tooltip = document.getElementById('bar-tooltip');
            if (!tooltip) {
              tooltip = document.createElement('div');
              tooltip.id = 'bar-tooltip';
              tooltip.className = 'absolute bg-gray-800 text-white py-1 px-2 rounded text-xs z-50 pointer-events-none';
              document.body.appendChild(tooltip);
            }
            
            // Set tooltip content and position
            tooltip.textContent = `${value} ${type}`;
            tooltip.style.display = 'block';
            
            // Position tooltip near the bar
            const rect = this.getBoundingClientRect();
            tooltip.style.left = `${rect.left + rect.width / 2 - tooltip.offsetWidth / 2}px`;
            tooltip.style.top = `${rect.top - tooltip.offsetHeight - 5}px`;
          });
          
          bar.addEventListener('mouseout', function() {
            // Hide tooltip on mouseout
            const tooltip = document.getElementById('bar-tooltip');
            if (tooltip) {
              tooltip.style.display = 'none';
            }
          });
        });
        
        // Check server status
        fetch(`${apiBaseUrl}/api/health`)
          .then(response => {
            if (!response.ok) {
              throw new Error(`HTTP error! Status: ${response.status}`);
            }
            return response.json();
          })
          .then(data => {
            document.getElementById('serverStatus').textContent = 
              `Server Status: ${data.status || 'Online'}`;
          })
          .catch(error => {
            console.error('Error checking server status:', error);
            document.getElementById('serverStatus').textContent = 
              `Server Status: Error - ${error.message}`;
          });
      });
    </script>
  </body>
</html>
